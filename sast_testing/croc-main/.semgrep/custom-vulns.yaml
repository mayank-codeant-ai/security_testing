rules:
  # ============================================================================
  # RULE 1: Command Injection via exec.Command
  # Tests deep taint tracking through multiple function calls
  # ============================================================================
  - id: go-command-injection-deep-flow
    languages: [go]
    message: >-
      Command injection vulnerability detected. User-controlled input flows
      through multiple functions before reaching exec.Command. An attacker
      can inject arbitrary commands.
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')"
      owasp: A03:2021 - Injection
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      subcategory: [vuln]
      technology: [go]
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: ($REQ : *http.Request).$FIELD
              - pattern: ($REQ : http.Request).$FIELD
          - metavariable-regex:
              metavariable: $FIELD
              regex: ^(Body|FormValue|PostFormValue|URL|Header)$
      - patterns:
          - pattern: json.NewDecoder($BODY).Decode(&$VAR)
          - focus-metavariable: $VAR
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: exec.Command($CMD, ...)
              - pattern: exec.CommandContext($CTX, $CMD, ...)
          - pattern-not: exec.Command("...", ...)
          - pattern-not: exec.CommandContext($CTX, "...", ...)

  # ============================================================================
  # RULE 2: SQL Injection via string concatenation
  # Tests taint tracking through query building functions
  # ============================================================================
  - id: go-sql-injection-deep-flow
    languages: [go]
    message: >-
      SQL injection vulnerability detected. User input flows through query
      building functions and is concatenated into SQL strings. Use
      parameterized queries instead.
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')"
      owasp: A03:2021 - Injection
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      subcategory: [vuln]
      technology: [go]
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: ($REQ : *http.Request).$FIELD
              - pattern: ($REQ : http.Request).$FIELD
          - metavariable-regex:
              metavariable: $FIELD
              regex: ^(Body|FormValue|PostFormValue|URL|Header|Query)$
      - patterns:
          - pattern: json.NewDecoder($BODY).Decode(&$VAR)
          - focus-metavariable: $VAR
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: $DB.Query($QUERY, ...)
              - pattern: $DB.Exec($QUERY, ...)
              - pattern: $DB.QueryRow($QUERY, ...)
          - pattern-not: $DB.Query("...", ...)
          - pattern-not: $DB.Exec("...", ...)

  # ============================================================================
  # RULE 3: Path Traversal via file operations
  # Tests taint tracking through path resolution functions
  # ============================================================================
  - id: go-path-traversal-deep-flow
    languages: [go]
    message: >-
      Path traversal vulnerability detected. User-controlled input flows
      through path resolution functions to file operations. An attacker
      can access arbitrary files outside the intended directory.
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')"
      owasp: A01:2021 - Broken Access Control
      confidence: HIGH
      likelihood: MEDIUM
      impact: HIGH
      subcategory: [vuln]
      technology: [go]
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: ($REQ : *http.Request).$FIELD
              - pattern: ($REQ : http.Request).$FIELD
          - metavariable-regex:
              metavariable: $FIELD
              regex: ^(URL|FormValue|PostFormValue|Body|Query)$
      - patterns:
          - pattern: json.NewDecoder($BODY).Decode(&$VAR)
          - focus-metavariable: $VAR
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: os.Open($PATH)
              - pattern: os.OpenFile($PATH, ...)
              - pattern: os.Create($PATH)
              - pattern: os.ReadFile($PATH)
              - pattern: os.WriteFile($PATH, ...)
              - pattern: io.ReadAll($FILE)
          - focus-metavariable: $PATH
    pattern-sanitizers:
      - patterns:
          - pattern: filepath.Base($PATH)
          - focus-metavariable: $PATH

  # ============================================================================
  # RULE 4: SSRF via HTTP client
  # Tests taint tracking through URL building functions
  # ============================================================================
  - id: go-ssrf-deep-flow
    languages: [go]
    message: >-
      Server-Side Request Forgery (SSRF) vulnerability detected.
      User-controlled input flows through URL construction functions
      to HTTP client calls. An attacker can make requests to internal
      services or arbitrary external hosts.
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-918: Server-Side Request Forgery (SSRF)"
      owasp: A10:2021 - Server-Side Request Forgery
      confidence: HIGH
      likelihood: MEDIUM
      impact: MEDIUM
      subcategory: [vuln]
      technology: [go]
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: ($REQ : *http.Request).$FIELD
              - pattern: ($REQ : http.Request).$FIELD
          - metavariable-regex:
              metavariable: $FIELD
              regex: ^(URL|Body|FormValue|PostFormValue|Header|Query)$
      - patterns:
          - pattern: json.NewDecoder($BODY).Decode(&$VAR)
          - focus-metavariable: $VAR
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: http.Get($URL)
              - pattern: http.Post($URL, ...)
              - pattern: http.NewRequest($METHOD, $URL, ...)
              - pattern: $CLIENT.Get($URL)
              - pattern: $CLIENT.Post($URL, ...)
          - focus-metavariable: $URL

  # ============================================================================
  # RULE 5: Weak Cryptography - MD5/SHA1 usage
  # Tests detection of weak hash algorithms
  # ============================================================================
  - id: go-weak-crypto-hash
    languages: [go]
    message: >-
      Use of weak cryptographic hash function detected. MD5 and SHA1 are
      considered cryptographically weak and should not be used for
      security-sensitive operations. Use SHA-256 or stronger.
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-328: Use of Weak Hash"
      owasp: A02:2021 - Cryptographic Failures
      confidence: HIGH
      likelihood: MEDIUM
      impact: MEDIUM
      subcategory: [vuln]
      technology: [go]
    patterns:
      - pattern-either:
          - pattern: md5.New()
          - pattern: md5.Sum(...)
          - pattern: sha1.New()
          - pattern: sha1.Sum(...)
          - pattern: crypto/md5
          - pattern: crypto/sha1
